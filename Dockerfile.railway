FROM denoland/deno:2.1.4

WORKDIR /app

# Copy dependency files first for caching
COPY backend/deno.json ./backend/
COPY shared/ ./shared/

# Cache dependencies
RUN cd backend && deno cache --reload npm:hono@4 npm:zod@3 npm:jose@5 npm:viem@2 npm:@anthropic-ai/sdk@0.39 npm:postgres@3

# Copy backend source
COPY backend/ ./backend/

# Update import map for container paths
WORKDIR /app/backend
RUN sed -i 's|"@shared/": "../shared/"|"@shared/": "/app/shared/"|' deno.json

# Cache main entry
RUN deno cache main.ts

USER deno

EXPOSE 8080
ENV PORT=8080
ENV DENO_ENV=production

CMD ["run", "--allow-net", "--allow-env", "--allow-read", "main.ts"]
