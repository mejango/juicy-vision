# RPC Proxy Configuration for Forge Fork Tests
#
# This proxy provides:
# - Method filtering (only read-only methods allowed)
# - Rate limiting
# - Chain routing based on path

worker_processes 1;

events {
    worker_connections 256;
}

http {
    # Rate limiting: 100 requests per minute per client
    limit_req_zone $binary_remote_addr zone=rpc_limit:10m rate=100r/m;

    # Upstream RPC endpoints
    upstream eth_mainnet {
        server eth.llamarpc.com:443;
        keepalive 4;
    }

    upstream optimism {
        server optimism.llamarpc.com:443;
        keepalive 4;
    }

    upstream base {
        server base.llamarpc.com:443;
        keepalive 4;
    }

    upstream arbitrum {
        server arbitrum.llamarpc.com:443;
        keepalive 4;
    }

    upstream sepolia {
        server sepolia.llamarpc.com:443;
        keepalive 4;
    }

    upstream base_sepolia {
        server base-sepolia.llamarpc.com:443;
        keepalive 4;
    }

    # Allowed methods map (only read-only methods)
    map $request_body $method_allowed {
        default 0;
        ~*"eth_call" 1;
        ~*"eth_getCode" 1;
        ~*"eth_getBalance" 1;
        ~*"eth_getStorageAt" 1;
        ~*"eth_getBlockByNumber" 1;
        ~*"eth_getBlockByHash" 1;
        ~*"eth_getTransactionByHash" 1;
        ~*"eth_getTransactionReceipt" 1;
        ~*"eth_getLogs" 1;
        ~*"eth_chainId" 1;
        ~*"eth_blockNumber" 1;
        ~*"net_version" 1;
    }

    server {
        listen 80;
        server_name localhost;

        # Health check
        location /health {
            return 200 '{"status":"healthy"}';
            add_header Content-Type application/json;
        }

        # Chain ID routing
        location ~ ^/1$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://eth.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host eth.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        location ~ ^/10$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://optimism.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host optimism.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        location ~ ^/8453$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://base.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host base.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        location ~ ^/42161$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://arbitrum.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host arbitrum.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        location ~ ^/11155111$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://sepolia.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host sepolia.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        location ~ ^/84532$ {
            limit_req zone=rpc_limit burst=20 nodelay;

            if ($method_allowed = 0) {
                return 403 '{"error":"Method not allowed"}';
            }

            proxy_pass https://base-sepolia.llamarpc.com;
            proxy_ssl_server_name on;
            proxy_set_header Host base-sepolia.llamarpc.com;
            proxy_set_header Content-Type application/json;
        }

        # Catch-all: unknown chain
        location / {
            return 404 '{"error":"Chain not supported"}';
            add_header Content-Type application/json;
        }
    }
}
